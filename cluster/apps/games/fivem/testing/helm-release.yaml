---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: fivem-testing
  namespace: games
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 2.0.3
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system
      interval: 15m
  values:
    controllers:
      main:
        containers:
          main:
            image:
              repository: spritsail/fivem
              tag: 7075
            env:
              TZ: "America/Chicago"
              NO_LICENSE_KEY: true
              NO_DEFAULT_CONFIG: true
            resources:
              requests:
                cpu: 4000m
                memory: 8192Mi
              limits:
                memory: 8192Mi
              probes:
                # -- Liveness probe configuration
                # @default -- See below
                liveness:
                  # -- Enable the liveness probe
                  enabled: false
                  # -- Set this to `true` if you wish to specify your own livenessProbe
                  custom: false
                  # -- sets the probe type when not using a custom probe
                  # @default -- "TCP"
                  type: TCP
                  # -- The spec field contains the values for the default livenessProbe.
                  # If you selected `custom: true`, this field holds the definition of the livenessProbe.
                  # @default -- See below
                  spec:
                    initialDelaySeconds: 0
                    periodSeconds: 10
                    timeoutSeconds: 1
                    failureThreshold: 3

                # -- Redainess probe configuration
                # @default -- See below
                readiness:
                  # -- Enable the readiness probe
                  enabled: false
                  # -- Set this to `true` if you wish to specify your own readinessProbe
                  custom: false
                  # -- sets the probe type when not using a custom probe
                  # @default -- "TCP"
                  type: TCP
                  # -- The spec field contains the values for the default readinessProbe.
                  # If you selected `custom: true`, this field holds the definition of the readinessProbe.
                  # @default -- See below
                  spec:
                    initialDelaySeconds: 0
                    periodSeconds: 10
                    timeoutSeconds: 1
                    failureThreshold: 3

                # -- Startup probe configuration
                # @default -- See below
                startup:
                  # -- Enable the startup probe
                  enabled: false
                  # -- Set this to `true` if you wish to specify your own startupProbe
                  custom: false
                  # -- sets the probe type when not using a custom probe
                  # @default -- "TCP"
                  type: TCP
                  # -- The spec field contains the values for the default startupProbe.
                  # If you selected `custom: true`, this field holds the definition of the startupProbe.
                  # @default -- See below
                  spec:
                    initialDelaySeconds: 0
                    timeoutSeconds: 1
                    ## This means it has a maximum of 5*30=150 seconds to start up before it fails
                    periodSeconds: 5
                    failureThreshold: 30

    service:
      main:
        ports:
          http:
            port: 40120
      fivem:
        enabled: true
        controller: main
        primary: false
        type: LoadBalancer
        loadBalancerIP: 10.10.202.10
        annotations:
          metallb.universe.tf/allow-shared-ip: "fivem-testing"
        ports:
          fivem-tcp:
            enabled: true
            primary: false
            protocol: TCP
            port: 30120
            targetPort: 30120
          fivem-udp:
            enabled: true
            primary: false
            protocol: UDP
            port: 30120
            targetPort: 30120


    ingress:
      main:
        enabled: true
        className: nginx-internal
        annotations:
          hajimari.io/enable: "true"
          hajimari.io/appName: "FiveM txAdmin"
          # hajimari.io/info: "Inventory management system"
          hajimari.io/icon: "devices"
          hajimari.io/targetBlank: "true"
        hosts:
          - host: testing.fivem.sparks.codes
            paths:
              - path: "/"
                pathType: "Prefix"
                service:
                  name: main
        tls:
          - hosts:
              - testing.fivem.sparks.codes
            secretName: acme-crt-secret-fivem-sparks-codes

    persistence:
      config:
        enabled: true
        globalMounts:
          - path: /config
        existingClaim: local-fivem-testing-config
      tx-data:
        enabled: true
        globalMounts:
          - path: /txData
        existingClaim: local-fivem-testing-txdata

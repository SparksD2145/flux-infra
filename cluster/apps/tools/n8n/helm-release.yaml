---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: n8n
  namespace: tools
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 3.7.3
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system
      interval: 15m
  values:
    defaultPodOptions:
      securityContext:
        fsGroup: 1000
        runAsUser: 1000
    controllers:
      main:
        containers:
          main:
            image:
              repository: docker.n8n.io/n8nio/n8n
              tag: latest
            env:
              N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: "true"
              N8N_RUNNERS_ENABLED: "true"
              GENERIC_TIMEZONE: "America/Chicago"
              TZ: "America/Chicago"
              N8N_HOST: &host auto.sparks.codes
              N8N_EDITOR_BASE_URL: "https://auto.sparks.codes"
    service:
      main:
        controller: main
        ports:
          http:
            port: 5678
    ingress:
      main:
        enabled: true
        className: "cloudflare-tunnel"
        annotations:
          hajimari.io/enable: "true"
          hajimari.io/appName: "n8n Automation"
          hajimari.io/info: "Automations toolset"
          hajimari.io/icon: "auto-mode"
        hosts:
          - host: *host
            paths:
              - path: "/"
                pathType: "Prefix"
                service:
                  identifier: main
                  port: http
        tls:
          - hosts:
              - *host
            secretName: acme-crt-secret-sparks-codes
    persistence:
      data:
        enabled: true
        storageClass: ceph-filesystem
        accessMode: ReadWriteMany
        size: 50Gi
        globalMounts:
          - path: /home/node/.n8n
        retain: true
